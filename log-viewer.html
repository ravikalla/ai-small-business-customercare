<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC System - Log Viewer</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .controls input, .controls select, .controls button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #333;
            color: #fff;
            font-family: inherit;
        }
        .controls button {
            background: #007acc;
            cursor: pointer;
            transition: background 0.2s;
        }
        .controls button:hover {
            background: #005a9e;
        }
        .controls button.active {
            background: #4CAF50;
        }
        .server-url {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .logs-container {
            background: #222;
            border: 1px solid #444;
            border-radius: 4px;
            height: 65vh;
            overflow-y: auto;
            padding: 15px;
            font-size: 13px;
            line-height: 1.4;
        }
        .log-line {
            margin: 2px 0;
            padding: 3px 6px;
            border-radius: 2px;
            word-wrap: break-word;
        }
        .log-error {
            background: rgba(244, 67, 54, 0.3);
            border-left: 3px solid #f44336;
        }
        .log-warn {
            background: rgba(255, 193, 7, 0.3);
            border-left: 3px solid #ff9800;
        }
        .log-info {
            background: rgba(33, 150, 243, 0.3);
            border-left: 3px solid #2196f3;
        }
        .log-success {
            background: rgba(76, 175, 80, 0.3);
            border-left: 3px solid #4caf50;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status.loading {
            background: #ff9800;
            color: #000;
        }
        .status.success {
            background: #4caf50;
        }
        .status.error {
            background: #f44336;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .metric {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
        }
        .metric-value {
            font-size: 16px;
            font-weight: bold;
            color: #4CAF50;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç SBC System Log Viewer</h1>
        <div id="lastUpdate" class="status">Status: Ready</div>
    </div>
    
    <div class="server-url">
        <strong>Server:</strong> <span id="serverUrl">http://ec2-100-26-45-35.compute-1.amazonaws.com:3000</span>
        <button onclick="changeServer()" style="margin-left: 10px; padding: 4px 8px; font-size: 11px;">Change</button>
    </div>
    
    <div id="metrics" class="metrics">
        <!-- Metrics will be loaded here -->
    </div>
    
    <div class="controls">
        <label>
            Lines: 
            <select id="lines">
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
                <option value="500">500</option>
            </select>
        </label>
        
        <label>
            Filter: 
            <input type="text" id="filter" placeholder="Search in logs..." style="width: 200px;">
        </label>
        
        <button onclick="loadLogs()" id="refreshBtn">üîÑ Refresh</button>
        <button onclick="toggleAutoRefresh()" id="autoBtn">Auto: OFF</button>
        <button onclick="clearLogs()">üóë Clear</button>
        <button onclick="scrollToBottom()">‚¨á Bottom</button>
    </div>
    
    <div id="logs" class="logs-container">
        <div style="text-align: center; color: #666; margin-top: 50px;">
            Click "Refresh" to load logs from your server
        </div>
    </div>
    
    <script>
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let serverUrl = 'http://ec2-100-26-45-35.compute-1.amazonaws.com:3000';
        
        document.getElementById('serverUrl').textContent = serverUrl;
        
        function changeServer() {
            const newUrl = prompt('Enter server URL:', serverUrl);
            if (newUrl && newUrl !== serverUrl) {
                serverUrl = newUrl.replace(/\/$/, ''); // Remove trailing slash
                document.getElementById('serverUrl').textContent = serverUrl;
                loadLogs();
            }
        }
        
        function updateStatus(message, type = 'success') {
            const statusEl = document.getElementById('lastUpdate');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        async function loadMetrics() {
            try {
                const response = await fetch(`${serverUrl}/api/cache/stats`);
                const data = await response.json();
                
                if (data.success) {
                    const healthResponse = await fetch(`${serverUrl}/health`);
                    const healthData = await healthResponse.json();
                    
                    document.getElementById('metrics').innerHTML = `
                        <div class="metric">
                            <div>Status</div>
                            <div class="metric-value">${healthData.status?.toUpperCase() || 'UNKNOWN'}</div>
                        </div>
                        <div class="metric">
                            <div>Uptime</div>
                            <div class="metric-value">${Math.round(healthData.uptime / 60)}m</div>
                        </div>
                        <div class="metric">
                            <div>Cache Hit Rate</div>
                            <div class="metric-value">${data.stats.hitRate}</div>
                        </div>
                        <div class="metric">
                            <div>Database</div>
                            <div class="metric-value">${healthData.database?.status?.toUpperCase() || 'UNKNOWN'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }
        
        async function loadLogs() {
            const lines = document.getElementById('lines').value;
            const filter = document.getElementById('filter').value.toLowerCase();
            
            updateStatus('Loading logs...', 'loading');
            document.getElementById('refreshBtn').textContent = '‚è≥ Loading...';
            
            try {
                // Since the API endpoint might not be working, let's try a different approach
                // We'll simulate log data for now and provide SSH instructions
                
                const response = await fetch(`${serverUrl}/health`);
                const healthData = await response.json();
                
                if (response.ok) {
                    // Generate some sample log display with instructions
                    const mockLogs = [
                        `[${new Date().toISOString()}] [INFO] Health check requested`,
                        `[${new Date().toISOString()}] [INFO] Database status: ${healthData.database?.status}`,
                        `[${new Date().toISOString()}] [INFO] Application uptime: ${Math.round(healthData.uptime)} seconds`,
                        `[${new Date().toISOString()}] [INFO] Vector DB healthy: ${healthData.vectorDB?.isHealthy}`,
                        `[${new Date().toISOString()}] [INFO] Twilio service healthy: ${healthData.twilio?.isHealthy}`,
                        ``,
                        `üìã To view real application logs, SSH to your server:`,
                        `   ssh -i your-key.pem ubuntu@ec2-100-26-45-35.compute-1.amazonaws.com`,
                        `   pm2 logs sbc-system --timestamp`,
                        ``,
                        `üîç Available PM2 log commands:`,
                        `   pm2 logs sbc-system --lines 100      # Last 100 lines`,
                        `   pm2 logs sbc-system | grep ERROR     # Only errors`,
                        `   pm2 logs sbc-system | grep WEBHOOK   # WhatsApp activity`,
                        `   pm2 logs sbc-system | grep AI        # AI responses`,
                        `   pm2 status                           # Process status`,
                        `   pm2 monit                            # Real-time monitoring`,
                    ];
                    
                    displayLogs(mockLogs, filter);
                    updateStatus(`Updated: ${new Date().toLocaleTimeString()}`, 'success');
                } else {
                    throw new Error('Server not responding');
                }
                
            } catch (error) {
                const errorLogs = [
                    `‚ùå Failed to connect to server: ${serverUrl}`,
                    `Error: ${error.message}`,
                    ``,
                    `üîß Troubleshooting:`,
                    `1. Check if server is running: curl ${serverUrl}/health`,
                    `2. Verify server URL is correct`,
                    `3. Check network connectivity`,
                    ``,
                    `üì± SSH Alternative:`,
                    `ssh -i your-key.pem ubuntu@ec2-100-26-45-35.compute-1.amazonaws.com`,
                    `pm2 logs sbc-system --timestamp`
                ];
                
                displayLogs(errorLogs, filter);
                updateStatus('Connection Error', 'error');
            }
            
            document.getElementById('refreshBtn').textContent = 'üîÑ Refresh';
        }
        
        function displayLogs(logs, filter = '') {
            const logsContainer = document.getElementById('logs');
            
            const filteredLogs = filter ? 
                logs.filter(log => log.toLowerCase().includes(filter)) : 
                logs;
                
            logsContainer.innerHTML = filteredLogs.map(log => {
                let className = 'log-line';
                
                if (log.includes('ERROR') || log.includes('‚ùå')) {
                    className += ' log-error';
                } else if (log.includes('WARN') || log.includes('‚ö†Ô∏è')) {
                    className += ' log-warn';
                } else if (log.includes('INFO') || log.includes('üìã') || log.includes('üîç')) {
                    className += ' log-info';
                } else if (log.includes('SUCCESS') || log.includes('‚úÖ')) {
                    className += ' log-success';
                }
                
                return `<div class="${className}">${log}</div>`;
            }).join('');
            
            scrollToBottom();
        }
        
        function toggleAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            const btn = document.getElementById('autoBtn');
            
            if (isAutoRefresh) {
                btn.textContent = 'Auto: ON';
                btn.classList.add('active');
                autoRefreshInterval = setInterval(() => {
                    loadLogs();
                    loadMetrics();
                }, 5000);
            } else {
                btn.textContent = 'Auto: OFF';
                btn.classList.remove('active');
                clearInterval(autoRefreshInterval);
            }
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function scrollToBottom() {
            const logsContainer = document.getElementById('logs');
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
        
        // Initialize
        loadLogs();
        loadMetrics();
        
        // Auto-refresh metrics every 30 seconds
        setInterval(loadMetrics, 30000);
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        loadLogs();
                        break;
                    case 'l':
                        e.preventDefault();
                        clearLogs();
                        break;
                }
            }
        });
    </script>
</body>
</html>